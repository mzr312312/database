# 数据聚合脚本 README

## 概述

这个 Python 脚本用于从多个数据库表中聚合数据，创建一个统一的汇总表。它特别设计用于处理不同基地的数据，支持 12 个基地的数据处理。

## 主要功能

1. 从 JSON 配置文件加载数据映射规则
2. 连接到 MySQL 数据库
3. 为每个基地创建汇总表
4. 从多个源表聚合数据到汇总表
5. 验证数据完整性（行数检查）

## 环境要求

- Python 3.6+
- MySQL 数据库
- Python 依赖包：
  - mysql-connector-python
  - json

## 配置文件说明 (`table_aggregator_config.json`)

### 结构
```json
{
  "table_name_template": "1_汇总表_{base_id}_{base_name}",
  "column_mapping": {
    "源字段名1": "目标字段名1",
    "源字段名2": "目标字段名2",
    ...
  },
  "column_order": [
    "目标字段名1",
    "目标字段名2",
    ...
  ]
}
```

### 字段说明
- **table_name_template**：汇总表的命名模板，使用 `{base_id}` 和 `{base_name}` 作为占位符
- **column_mapping**：源表字段到汇总表字段的映射关系
- **column_order**：汇总表中字段的显示顺序

## 使用步骤

1. **准备配置文件**：
   - 创建 `table_aggregator_config.json` 文件
   - 根据您的数据结构配置字段映射和顺序

2. **安装依赖**：
   ```bash
   pip install mysql-connector-python
   ```

3. **配置数据库连接**：
   在代码中修改以下连接参数：
   ```python
   connection = mysql.connector.connect(
       host='localhost',
       user='mazhuoran',
       password='mazhuoran',
       database='mzr_db'
   )
   ```

4. **运行脚本**：
   ```bash
   python data_aggregator.py
   ```

## 输出说明

脚本将为每个基地创建汇总表，命名格式为：`1_汇总表_{基地ID}_{基地名称}`

汇总表包含以下字段（按配置顺序）：
- 聚合名称
- 聚合名称_编码
- 聚合分类
- 采集点名称
- 数据源名称
- 采集点编码
- 采集点ID
- 设备名称
- 设备ID
- 车间
- 设备编码
- 校验状态
- 一般属性
- 业务属性
- 采集点分类
- 设备类型
- 设备子类型
- 设备属性（生产/厂务）
- 服务名称
- 服务编码
- 服务是否启用
- 统计类型
- 计算方式
- 接口名称
- 接口编码
- 接口类型
- 接口URL
- 接口服务对象
- 接口topic
- 聚合编码
- 应用方
- 聚合维度
- 数据源数量
- 设备数量
- 采集点数量
- 聚合是否启用
- 基地
- 工段
- 工序

## 注意事项

1. 确保数据库连接参数正确
2. 配置文件必须包含所有必需的字段
3. 映射字段和目标字段必须完全匹配
4. 脚本会清空已存在的汇总表数据
5. 运行后会检查原始表和汇总表的行数是否一致
6. 基地名称映射在代码中硬编码，如需修改请编辑 `BASE_MAPPING` 字典

## 错误处理

脚本包含以下错误检查：
- 配置文件存在性检查
- 配置文件完整性验证
- 数据库连接错误处理
- 表创建错误处理
- 数据聚合错误处理
- 行数一致性检查

## 示例输出

```
开始数据聚合流程...
加载配置文件: table_aggregator_config.json
数据库连接成功
表 1_汇总表_1_扬州 创建成功或已存在
正在为基地 扬州 执行数据聚合...
数据已成功聚合到 1_汇总表_1_扬州
原始表c的行数: 1500
汇总表的行数: 1500
行数一致，所有数据已保留
--------------------------------------------------
...其他基地处理...
所有基地数据聚合完成!
数据库连接已关闭
```

## 支持基地

脚本支持以下12个基地的数据处理：
1. 扬州
2. 东台
3. 合肥
4. 鄂尔多斯
5. 曲靖
6. 奉贤
7. 包头
8. 义乌
9. 邢台
10. 宁晋
11. 石家庄
12. 巴彦淖尔